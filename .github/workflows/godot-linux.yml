# Isolated CI/CD workflow for Linux exports via Godot CLI, 
# using GDNative/Rust libraries that need to be built.
name: Linux Export

on: push

jobs:
  # This job is where we test Rust source code and then compile it for Linux target
  rust-linux:
    runs-on: ubuntu-latest
    name: Building Rust source for Linux
    steps:
    - uses: actions/checkout@v2
    - name: Check Rust toolchain
      run: rustup show
    - name: Run tests
      run: cargo test --release
    - name: Build
      run: cargo build --release
    - name: Upload GDNative library as artifact
      uses: actions/upload-artifact@v1
      with:
        name: libcore.so
        path: target/release/libcore.so

  # This job is where we build a Godot game for Linux,
  # using the Linux-compatible library we built in 'rust-linux'
  godot-linux:
    runs-on: ubuntu-latest
    needs: rust-linux
    name: Building Godot game for Linux/X11
    steps:
    - uses: actions/checkout@v2
    - name: Setup environment
      run: |
        sudo apt-get install tree
        wget https://downloads.tuxfamily.org/godotengine/3.2.1/Godot_v3.2.1-stable_linux_headless.64.zip
        wget https://downloads.tuxfamily.org/godotengine/3.2.1/Godot_v3.2.1-stable_export_templates.tpz
        mkdir ~/.cache
        mkdir -p ~/.config/godot
        mkdir -p ~/.local/share/godot/templates/3.2.1.stable
        unzip Godot_v3.2.1-stable_linux_headless.64.zip
        sudo mv Godot_v3.2.1-stable_linux_headless.64 /usr/local/bin/godot
        unzip Godot_v3.2.1-stable_export_templates.tpz
        sudo mv templates/* ~/.local/share/godot/templates/3.2.1.stable
        sudo rm -f Godot_v3.2.1-stable_linux_headless.64.zip Godot_v3.2.1-stable_export_templates.tpz
        mkdir -p ./build/linux
    - name: Download GDNative library artifact
      uses: actions/download-artifact@v1
      with:
        name: libcore.so
        path: target/stable-x86_64-unknown-linux-gnu/release
    - name: Checking project structure for troubleshooting
      run: tree
    - name: Building for Linux/X11
      run: godot -v --export "Linux/X11" ./build/linux/sample_godot_rust_app.x86_64
    - name: Checking final build structure for troubleshooting
      run: tree ./build
    - name: Upload Linux game as artifact
      uses: actions/upload-artifact@v1
      with:
        name: sample_godot_rust_app_linux
        path: build/linux
