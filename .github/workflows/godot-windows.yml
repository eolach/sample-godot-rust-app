# Isolated CI/CD workflow for Windows exports via Godot CLI, 
# using GDNative/Rust libraries that need to be built.
name: Windows Export

on: push

jobs:
  # This job is where we compile Rust source code for Windows target
  rust-windows:
    runs-on: ubuntu-latest
    name: Building Rust source for Windows
    steps:
    - uses: actions/checkout@v2
    - name: Check Rust toolchain
      run: rustup show
    - name: Install Cross
      run: cargo install cross
    - name: Build custom Docker image for x86_64-pc-windows-gnu toolchain with LLVM
      run: docker build -t my/x86_64-pc-windows-gnu:latest -f ./dockerfiles/x86_64-pc-windows-gnu.Dockerfile .
    - name: Test with Cross
      run: cross test --release --target x86_64-pc-windows-gnu
    - name: Build with Cross
      run: cross build --release --target x86_64-pc-windows-gnu
    - name: Upload GDNative library as artifact
      uses: actions/upload-artifact@v1
      with:
        name: core.dll
        path: target/x86_64-pc-windows-gnu/release/core.dll

  # This job is where we build a Godot game for Windows,
  # using the Windows-compatible library we built in 'rust-windows'
  godot-windows:
    runs-on: ubuntu-latest
    needs: rust-windows
    name: Building Godot game for Windows
    steps:
    - uses: actions/checkout@v2
    - name: Setup environment
      run: |
        sudo apt-get install tree
        wget https://downloads.tuxfamily.org/godotengine/3.2.1/Godot_v3.2.1-stable_linux_headless.64.zip
        wget https://downloads.tuxfamily.org/godotengine/3.2.1/Godot_v3.2.1-stable_export_templates.tpz
        mkdir ~/.cache
        mkdir -p ~/.config/godot
        mkdir -p ~/.local/share/godot/templates/3.2.1.stable
        unzip Godot_v3.2.1-stable_linux_headless.64.zip
        sudo mv Godot_v3.2.1-stable_linux_headless.64 /usr/local/bin/godot
        unzip Godot_v3.2.1-stable_export_templates.tpz
        sudo mv templates/* ~/.local/share/godot/templates/3.2.1.stable
        sudo rm -f Godot_v3.2.1-stable_linux_headless.64.zip Godot_v3.2.1-stable_export_templates.tpz
        mkdir -p ./build/windows
    - name: Download GDNative library artifact
      uses: actions/download-artifact@v1
      with:
        name: core.dll
        path: target/x86_64-pc-windows-gnu/release
    - name: Checking project structure for troubleshooting
      run: tree
    - name: Building for Windows
      run: godot -v --export "Windows Desktop" ./build/windows/sample_godot_rust_app.exe
    - name: Checking final build structure for troubleshooting
      run: tree ./build
    - name: Upload Windows game as artifact
      uses: actions/upload-artifact@v1
      with:
        name: sample_godot_rust_app_windows
        path: build/windows